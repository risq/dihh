!function(e,t){"use strict";"function"==typeof define&&define.amd?define(t):"object"==typeof exports?module.exports=t:e.cratedigger=t(e)}(this,function(e){"use strict";function t(e){for(var t,n,o=e.length;o;t=parseInt(Math.random()*o),n=e[--o],e[o]=e[t],e[t]=n);return e}function n(e){return"function"==typeof e||!1}var o,a,i,s,r,c,d,l,u,f,m,E,p,h,g,v,T,y,w,R,P,x,M,I,b,H,C,z,O,W,N,L={},S={},B=!!document.querySelector&&!!e.addEventListener,F=[],j=[],k=[],Q="closed",Y=!0,D={x:0,y:0},A={x:0,y:0},X={x:0,y:0},G=-1,U=-1,V=0,q={debug:!0,canvasWidth:null,canvasHeight:null,nbCrates:2,recordsPerCrate:24,lightIntensity:1,cameraMouseMove:!0,backgroundColor:1118481,sleeveColor:853762,sleeveMaskTexture:"img/sleeve.png",crateTexture:"img/wood.jpg",closeInfoPanelOnClick:!0,closeInfoPanelOnScroll:!0,infoPanelOpacity:.9,postprocessing:!0,blurAmount:.4,updateCanvasSizeOnWindowResize:!0,onInfoPanelOpened:function(){},onInfoPanelClosed:function(){},onLoadingEnd:function(){},elements:{rootContainerId:"cratedigger",canvasContainerId:"cratedigger-canvas",loadingContainerId:"cratedigger-loading",infoContainerId:"cratedigger-info",titleContainerId:"cratedigger-record-title",artistContainerId:"cratedigger-record-artist",coverContainerId:"cratedigger-record-cover"},constants:{recordMoveTime:1e3,cameraMoveTime:800,infoOpenTime:800,recordBaseY:5,recordShownY:25,recordFlippedY:110,targetBasePosition:{x:-20,y:10,z:0},cameraBasePosition:{x:280,y:200,z:180},cameraFocusPosition:{x:160,y:190,z:85},cameraMouseMoveSpeedY:.07,cameraMouseMoveSpeedZ:.03,grabSensitivity:6}},Z=function(e,t,n){this.id=e,this.crateId=t,this.pos=n,this.state="out",this.recordXPos=-62+135/L.recordsPerCrate*n,this.mesh=new THREE.Mesh(new THREE.BoxGeometry(100,1.5,100,1,1,1),new THREE.MeshFaceMaterial(Wt(null,!1))),this.mesh.geometry.applyMatrix((new THREE.Matrix4).makeTranslation(50,0,0)),this.mesh.position.set(this.recordXPos,L.constants.recordBaseY,0),this.mesh.rotation.z=Math.PI/2,this.mesh.recordId=e,this.absolutePosition=new THREE.Vector3,this.setUnactive(),this.pushRecord()};Z.prototype.log=function(){console.log("Record nÂ°",this.id,"crateId =",this.crateId,"pos =",this.pos)},Z.prototype.setActive=function(){this.active=!0,this.mesh.visible=!0},Z.prototype.setUnactive=function(){this.active=!1,this.mesh.visible=!1},Z.prototype.showRecord=function(){"shown"!==this.state&&(this.state="shown",this.absolutePosition.setFromMatrixPosition(this.mesh.matrixWorld),new TWEEN.Tween(this.mesh.position).to({y:L.constants.recordShownY},L.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2},L.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(m.position).to({x:this.recordXPos,y:50+L.constants.recordShownY,z:this.absolutePosition.z},L.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(f.position).to({x:this.recordXPos+L.constants.cameraFocusPosition.x,y:L.constants.cameraFocusPosition.y,z:this.absolutePosition.z+L.constants.cameraFocusPosition.z},L.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},Z.prototype.pushRecord=function(){"pushed"!=this.state&&(this.state="pushed",new TWEEN.Tween(this.mesh.position).to({y:L.constants.recordBaseY},L.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2+Math.PI/7},L.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},Z.prototype.pullRecord=function(){"pulled"!==this.state&&(this.state="pulled",new TWEEN.Tween(this.mesh.position).to({y:L.constants.recordBaseY},L.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({z:Math.PI/2-Math.PI/7},L.constants.recordMoveTime).easing(TWEEN.Easing.Quartic.Out).start())},Z.prototype.flipRecord=function(e){this.state="flipped",new TWEEN.Tween(this.mesh.position).to({y:L.constants.recordFlippedY},L.constants.infoOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).delay(L.constants.infoOpenTime/4).to({y:Math.PI},L.constants.infoOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(m.position).to({x:this.recordXPos,y:L.constants.recordFlippedY+50,z:this.absolutePosition.z},L.constants.infoOpenTime).easing(TWEEN.Easing.Quartic.Out).start().onComplete(e),new TWEEN.Tween(f.position).to({x:this.recordXPos+L.constants.cameraFocusPosition.x+80,y:L.constants.cameraFocusPosition.y-50},L.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start()},Z.prototype.flipBackRecord=function(e,t){"flipped"===this.state&&(new TWEEN.Tween(this.mesh.position).delay(L.constants.infoOpenTime/2).to({y:L.constants.recordBaseY},L.constants.infoOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(this.mesh.rotation).to({y:0},L.constants.infoOpenTime/2).easing(TWEEN.Easing.Quartic.Out).start().onComplete(e),t||(new TWEEN.Tween(m.position).delay(L.constants.infoOpenTime/2).to({x:this.recordXPos,y:75,z:this.absolutePosition.z},L.constants.infoOpenTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(f.position).to({x:this.recordXPos+L.constants.cameraFocusPosition.x,y:L.constants.cameraFocusPosition.y},L.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start()))};var J=function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n]);return e},K=function(){Y&&(requestAnimationFrame(K),$(),L.debug&&l.update())},$=function(){TWEEN.update(),it(),L.cameraMouseMove&&(X.x=.25*(D.x/C-.5),X.y=.25*(D.y/C-.5),b.rotation.y+=L.constants.cameraMouseMoveSpeedY*(X.x-b.rotation.y),b.rotation.z+=L.constants.cameraMouseMoveSpeedZ*(X.y-b.rotation.z)),f.lookAt(m.position),L.postprocessing?(u.overrideMaterial=I,E.render(u,f,P),u.overrideMaterial=null,T.render()):E.render(u,f)},_=function(){for(var e=0;e<j.length;e++)j[e].data=null,j[e].setUnactive();V=0,k=[]},et=function(e,n,o){st(!0),wt(function(){V>0&&_(),n&&(e=t(e));for(var a=0;a<j.length&&a<e.length;a++)j[a].data=e[a],j[a].setActive(),j[a].mesh.material.materials=Wt(e[a].cover,e[a].hasSleeve);V=j.length,k=e,setTimeout(function(){Rt(i),L.onLoadingEnd(),o&&o()},2e3)})},tt=function(){var e=k;e=t(e),et(e)},nt=function(e){"opened"===Q?at():"opening"!==Q&&"closing"!==Q&&(G=e)},ot=function(){j[G]&&(mt(j[G]),Q="opening",j[G].flipRecord(function(){Q="opened"}),L.onInfoPanelOpened(),setTimeout(function(){Bt(s,L.infoPanelOpacity)},300))},at=function(e){"opened"===Q&&(St(s),Q="closing",j[G].flipBackRecord(function(){Q="closed",L.onInfoPanelClosed()},e))},it=function(){if("closed"===Q&&U!=G){U=G;for(var e=0;V>e;e++)-1==G?j[e].pushRecord():e>G&&e>j[G].crateId*L.recordsPerCrate&&e<j[G].crateId*L.recordsPerCrate+L.recordsPerCrate?j[e].pullRecord():e==G?j[e].showRecord():j[e].pushRecord()}},st=function(e){"opened"!==Q||e?"opening"!==Q&&"closing"!==Q&&("opened"===Q&&at(!0),G=-1,new TWEEN.Tween(m.position).to({x:L.constants.targetBasePosition.x,y:L.constants.targetBasePosition.y,z:L.constants.targetBasePosition.z},L.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start(),new TWEEN.Tween(f.position).to({x:L.constants.cameraBasePosition.x,y:L.constants.cameraBasePosition.y,z:L.constants.cameraBasePosition.z},L.constants.cameraMoveTime).easing(TWEEN.Easing.Quartic.Out).start()):at()},rt=function(){nt(dt(G))},ct=function(){nt(lt(G))},dt=function(e){return-1==e?e=V-1:V-1>e?e+=1:e=0,j[e].active?e:dt(e)},lt=function(e){return-1==e?e=V-1:e>0?e-=1:e=V-1,j[e].active?e:lt(e)},ut=function(e){"closed"===Q?"prev"===e?rt():ct():"opened"===Q&&L.closeInfoPanelOnScroll&&at()},ft=function(e,t){t=!t||Math.abs(t)>.5?.5:Math.abs(t);var n=1-t,o=n*n*n*300;W=setTimeout(function(){classie.add(E.domElement,"grab");var t=(e-D.y)/z;t>0?ct():0>t&&rt(),ft(e,t)},o)},mt=function(e){e.data.title&&(r.innerHTML=e.data.title),e.data.artist&&(c.innerHTML=e.data.artist),e.data.cover&&(d.style.backgroundImage="url("+e.data.cover+")")},Et=function(e){var t=0,n=0,o=0,a=0,i=this;if(e||(e=window.event),e.pageX||e.pageY?(t=e.pageX,n=e.pageY):(e.clientX||e.clientY)&&(t=e.clientX+document.body.scrollLeft+document.documentElement.scrollLeft,n=e.clientY+document.body.scrollTop+document.documentElement.scrollTop),i.offsetParent)do o+=i.offsetLeft,a+=i.offsetTop;while(i=i.offsetParent);D.x=t-o,D.y=n-a},pt=function(e){return Nt(e)<0?ut("prev"):ut("next"),!1},ht=function(e){if("closed"===Q){var t={x:(e.x-E.domElement.offsetLeft)/E.domElement.width*2-1,y:2*-((e.y-E.domElement.offsetTop)/E.domElement.height)+1,z:.5},n=new THREE.Vector3(t.x,t.y,t.z);n.unproject(f);var o=new THREE.Raycaster(f.position,n.sub(f.position).normalize()),a=o.intersectObjects(H.children,!0);if(a.length>0){for(var i,s=0;s<a.length&&"undefined"!=typeof a[s].object.recordId;s++)if(a[s].object.visible&&a[s].object.recordId>=0){i=j[a[s].object.recordId];break}i?G===i.id?ot():nt(i.id):st()}else st()}},gt=function(){clearInterval(W),"closed"===Q?(ft(D.y),A={x:D.x,y:D.y}):"opened"===Q&&L.closeInfoPanelOnClick&&at()},vt=function(){clearInterval(W),classie.remove(E.domElement,"grab"),Lt(A,D,L.constants.grabSensitivity)&&ht(A)},Tt=function(e){37===e.keyCode||38===e.keyCode?ut("next"):(39===e.keyCode||40===e.keyCode)&&ut("prev")},yt=function(){Ft(),jt(),E.setSize(C,z),f.aspect=C/z,f.updateProjectionMatrix(),w.uniforms.tDepth.value=P,w.uniforms.size.value.set(C,z),w.uniforms.textel.value.set(1/C,1/z),y.uniforms.resolution.value.set(1/C,1/z)},wt=function(e){Bt(i,1,e)},Rt=function(e){St(i,e)},Pt=function(){u=new THREE.Scene,E=new THREE.WebGLRenderer({antialias:!0}),E.setSize(C,z),a.appendChild(E.domElement),E.domElement.id="context",E.setClearColor(L.backgroundColor,1),f=new THREE.PerspectiveCamera(45,C/z,.1,2e4),f.focalLength=45,f.frameSize=32,f.setLens(f.focalLength,f.frameSize),m=new THREE.Object3D,f.lookAt(m.position),p=new THREE.Projector;var e=THREE.ImageUtils.loadTexture(L.crateTexture);e.anisotropy=E.getMaxAnisotropy(),N=new THREE.MeshLambertMaterial({map:e}),b=new THREE.Object3D,H=new THREE.Object3D,u.add(b),b.add(H),Ht(),zt(),h=new THREE.PointLight(16777215,1.1*L.lightIntensity),h.position.set(300,80,0),u.add(h),g=new THREE.PointLight(16777215,.6*L.lightIntensity),g.position.set(-100,300,1e3),u.add(g),v=new THREE.PointLight(16777215,.6*L.lightIntensity),v.position.set(-100,300,-1e3),u.add(v),xt(),o.addEventListener("DOMMouseScroll",pt,!1),o.addEventListener("mousewheel",pt,!1),o.addEventListener("mousemove",Et,!1),o.addEventListener("mousedown",gt,!1),o.addEventListener("mouseup",vt,!1),window.addEventListener("keydown",Tt,!1),L.updateCanvasSizeOnWindowResize&&window.addEventListener("resize",yt,!1),o.style.position="relative",a.style.position="absolute",s.style.position="absolute",i.style.position="absolute",jt(),s.style.display="none",L.debug&&(Mt(),It()),st(),K()},xt=function(){x=THREE.ShaderLib.depthRGBA,M=THREE.UniformsUtils.clone(x.uniforms),I=new THREE.ShaderMaterial({fragmentShader:x.fragmentShader,vertexShader:x.vertexShader,uniforms:M}),I.blending=THREE.NoBlending,P=new THREE.WebGLRenderTarget(C,z,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),T=new THREE.EffectComposer(E),T.addPass(new THREE.RenderPass(u,f)),w=new THREE.ShaderPass(THREE.DoFShader),w.uniforms.tDepth.value=P,w.uniforms.size.value.set(C,z),w.uniforms.textel.value.set(1/C,1/z),w.uniforms.znear.value=f.near,w.uniforms.zfar.value=f.far,w.uniforms.focalDepth.value=5,w.uniforms.focalLength.value=f.focalLength,w.uniforms.fstop.value=8,w.uniforms.showFocus.value=!1,w.uniforms.manualdof.value=!0,w.uniforms.ndofstart.value=11,w.uniforms.ndofdist.value=80,w.uniforms.fdofstart.value=0,w.uniforms.fdofdist.value=100,w.uniforms.CoC.value=.03,w.uniforms.vignetting.value=!1,w.uniforms.autofocus.value=!0,w.uniforms.focus.value.set(.35,.35),w.uniforms.maxblur.value=L.blurAmount,w.uniforms.threshold.value=0,w.uniforms.gain.value=0,w.uniforms.bias.value=0,w.uniforms.fringe.value=0,y=new THREE.ShaderPass(THREE.FXAAShader),y.uniforms.resolution.value.set(1/C,1/z),y.renderToScreen=!0,T.addPass(w),T.addPass(y)},Mt=function(){l=new Stats,l.domElement.style.position="absolute",l.domElement.style.left="0",l.domElement.style.top="0",o.appendChild(l.domElement);var e=new THREE.Mesh(new THREE.BoxGeometry(20,20,20,1,1,1));e.position.set(h.position.x,h.position.y,h.position.z),u.add(e)},It=function(){var e,t,n;R=new dat.GUI,L.postprocessing&&(e=R.addFolder("Camera"),t=e.add(f,"focalLength",28,200).name("Focal Length"),t.onChange(bt),n=R.addFolder("Depth of Field"),n.add(w.uniforms.focalDepth,"value",0,10).name("Focal Depth"),n.add(w.uniforms.fstop,"value",0,22).name("F Stop"),n.add(w.uniforms.maxblur,"value",0,3).name("max blur"),n.add(w.uniforms.showFocus,"value").name("Show Focal Range"),n.add(w.uniforms.manualdof,"value").name("Manual DoF"),n.add(w.uniforms.ndofstart,"value",0,200).name("near start"),n.add(w.uniforms.ndofdist,"value",0,200).name("near falloff"),n.add(w.uniforms.fdofstart,"value",0,200).name("far start"),n.add(w.uniforms.fdofdist,"value",0,200).name("far falloff"),n.add(w.uniforms.CoC,"value",0,.1).step(.001).name("circle of confusion"),n.add(w.uniforms.vignetting,"value").name("Vignetting"),n.add(w.uniforms.vignout,"value",0,2).name("outer border"),n.add(w.uniforms.vignin,"value",0,1).step(.01).name("inner border"),n.add(w.uniforms.vignfade,"value",0,22).name("fade at"),n.add(w.uniforms.autofocus,"value").name("Autofocus"),n.add(w.uniforms.focus.value,"x",0,1).name("focus x"),n.add(w.uniforms.focus.value,"y",0,1).name("focus y"),n.add(w.uniforms.threshold,"value",0,1).step(.01).name("threshold"),n.add(w.uniforms.gain,"value",0,100).name("gain"),n.add(w.uniforms.bias,"value",0,4).step(.01).name("bias"),n.add(w.uniforms.fringe,"value",0,5).step(.01).name("fringe"),n.add(w.uniforms.noise,"value").name("Use Noise"),n.add(w.uniforms.namount,"value",0,.001).step(1e-4).name("dither"),n.add(w.uniforms.depthblur,"value").name("Blur Depth"),n.add(w.uniforms.dbsize,"value",0,5).name("blur size")),R.close()},bt=function(){f.setLens(f.focalLength,f.frameSize),f.updateProjectionMatrix(),w.uniforms.focalLength.value=f.focalLength},Ht=function(){for(var e=0;e<L.nbCrates;e++){var t=Ct(e);H.add(t)}H.position.z=-(110-110*L.nbCrates)/2},Ct=function(e){F[e]=new THREE.Object3D;var t=new THREE.Mesh(new THREE.BoxGeometry(200,10,100),N);F[e].add(t);var n=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),N);if(n.position.set(0,35,-55),n.rotation.x=Math.PI/2,F[e].add(n),0===e){var o=new THREE.Mesh(new THREE.BoxGeometry(200,10,80),N);o.position.set(0,35,55),o.rotation.x=Math.PI/2,F[e].add(o)}var a=new THREE.Mesh(new THREE.BoxGeometry(80,10,120),N);a.position.set(-105,35,0),a.rotation.z=Math.PI/2,F[e].add(a);var i=new THREE.Mesh(new THREE.BoxGeometry(40,10,100),N);return i.position.set(95,25,0),i.rotation.z=Math.PI/2,F[e].add(i),F[e].position.z=-110*e,F[e]},zt=function(){for(var e=0,t=0;t<F.length;t++)for(var n=0;n<L.recordsPerCrate;n++)Ot(e,t,n),e++},Ot=function(e,t,n){var o=new Z(e,t,n);F[t].add(o.mesh),j.push(o)},Wt=function(e,t){var n=new Image;n.crossOrigin="Anonymous",n.src=e?e:"";var o=400,a=400,i=document.createElement("canvas");i.width=i.height=400;var s=new THREE.Texture(i);s.minFilter=THREE.LinearFilter,n.onload=function(){if(t){var e=new Image;e.src=L.sleeveMaskTexture,e.onload=function(){var t=i.getContext("2d");t.translate(o/2,a/2),t.rotate(Math.PI/2),t.translate(-o/2,-a/2),t.drawImage(n,130,130,135,135),t.drawImage(e,0,0,400,400),s.needsUpdate=!0}}else{var r=i.getContext("2d");r.translate(o/2,a/2),r.rotate(Math.PI/2),r.translate(-o/2,-a/2),r.drawImage(n,0,0,400,400),s.needsUpdate=!0}};var r=new THREE.MeshLambertMaterial({color:L.sleeveColor}),c=[r,r,r,new THREE.MeshLambertMaterial({color:16777215,map:s}),r,r];return c},Nt=function(e){return e||(e=event),e.detail<0?1:e.wheelDelta>0?1:-1},Lt=function(e,t,n){return Math.abs(e.x-t.x)<=n&&Math.abs(e.y-t.y)<=n},St=function(e,t){e.style.opacity<=.1?(e.style.display="none",e.style.opacity=0,n(t)&&t()):(e.style.opacity-=.1,setTimeout(function(){St(e,t)},10))},Bt=function(e,t,o,a){!e.style.opacity||e.style.opacity&&e.style.opacity<t?("none"==e.style.display?(e.style.display="block",a=0):e.style.display||(a=e.style.opacity||1),a+=.03,e.style.opacity=a,setTimeout(function(){Bt(e,t,o,a)},10)):(e.style.opacity=t,n(o)&&o())},Ft=function(){C=L.canvasWidth?L.canvasWidth:o.clientWidth,z=L.canvasHeight?L.canvasHeight:o.clientHeight},jt=function(){a.style.height=z+"px",s.style.height=z+"px",i.style.height=z+"px",a.style.width=C+"px",s.style.width=C+"px",i.style.width=C+"px"};return S.init=function(e){if(L=J(q,e),B&&Modernizr.webgl){if(console.log("Initializing cratedigger.js..."),O=void 0!==window.devicePixelRatio?window.devicePixelRatio:1,o=document.getElementById(L.elements.rootContainerId),!o)return console.error("cratedigger.js - Init failed : can not find root container element."),void 0;if(a=document.getElementById(L.elements.canvasContainerId),!a)return console.error("cratedigger.js - Init failed : can not find canvas container element."),void 0;if(i=document.getElementById(L.elements.loadingContainerId),!i)return console.error("cratedigger.js - Init failed : can not find loading container element."),void 0;if(s=document.getElementById(L.elements.infoContainerId),!s)return console.error("cratedigger.js - Init failed : can not find info container element."),void 0;if(r=document.getElementById(L.elements.titleContainerId),!r)return console.error("cratedigger.js - Init failed : can not find record title container element."),void 0;if(c=document.getElementById(L.elements.artistContainerId),!c)return console.error("cratedigger.js - Init failed : can not find record artist container element."),void 0;if(d=document.getElementById(L.elements.coverContainerId),!d)return console.error("cratedigger.js - Init failed : can not find cover image container element."),void 0;Ft(),Pt()}},S.selectRecord=function(e){0>e?st():G=e>V?V-1:e},S.startRender=function(){Y=!0,K()},S.stopRender=function(){Y=!1},S.enablePostprocessing=function(){L.postprocessing=!0},S.disablePostprocessing=function(){L.postprocessing=!1},S.getCanvas=function(){return E.domElement},S.getRecordsDataList=function(){return k},S.getLoadedRecords=function(){return V},S.getSelectedRecord=function(){return j[G]},S.loadRecords=et,S.unloadRecords=_,S.resetShownRecord=st,S.shuffleRecords=tt,S.flipSelectedRecord=ot,S.selectPrevRecord=rt,S.selectNextRecord=ct,S.showLoading=wt,S.hideLoading=Rt,S});